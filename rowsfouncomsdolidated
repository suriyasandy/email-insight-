for file in csv_files:
    base_name = file.replace("\\", "/").split("/")[-1].replace(".csv", "")
    trade_id = base_name.split("_")[0]
    rows_found = False

    with open(file, newline="", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        csv_headers = list(reader.fieldnames) if reader.fieldnames else []
        expected_headers = static_headers[1:]

        if csv_headers == expected_headers:
            # All headers match, append rows normally
            for row in reader:
                out_row = [trade_id]
                for header in expected_headers:
                    out_row.append(row.get(header, ""))
                ws.append(out_row)
                rows_found = True
        elif "Date" in csv_headers:
            # Date present but headers not fully matching - append comment
            out_row = [trade_id] + [""] * (len(static_headers) - 1)
            ws.append(out_row)
            ws.append([f"Partial header mismatch - Check file: {base_name}"])
            rows_found = True
        else:
            # No Date column found - Trade Id not found message
            out_row = [trade_id] + [""] * (len(static_headers) - 1)
            ws.append(out_row)
            ws.append([f"Trade Id Not Found In Mail - Check file: {base_name}"])

